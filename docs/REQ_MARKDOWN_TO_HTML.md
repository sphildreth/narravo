# Markdown to HTML Rendering Strategy

## Overview

To securely handle user-generated content for both posts and comments, this document outlines a strategy to convert Markdown into sanitized HTML on the server side. This approach ensures that no raw user input is rendered directly on the client, mitigating the risk of Cross-Site Scripting (XSS) attacks. It also improves performance by pre-rendering the HTML.

## Core Principle

The fundamental principle is to store user content in two formats in the database:

1.  **Raw Markdown:** The original content as provided by the user. This allows for future edits and preserves the source material.
2.  **Rendered HTML:** Pre-rendered and sanitized HTML, generated by the server. This is the "safe" content that will be displayed to users.

---

## Implementation Details

### 1. Posts

-   **Editing Experience:** A WYSIWYG (What You See Is What You Get) editor will be used for creating and editing posts.
-   **Database Schema:** The `posts` table will require changes to support this. The existing `html` column will be renamed to `body_html`, and a new `body_md` column will be added to store the raw Markdown.
-   **Storage:** The content from the editor will be saved as Markdown to the `body_md` column.
-   **Server-Side Rendering:** On every save (create or update), the server will:
    1.  Take the raw Markdown from the input.
    2.  Use a library (e.g., `marked`) to convert the Markdown to HTML.
    3.  Use a sanitization library (e.g., `DOMPurify`) to clean the generated HTML, stripping any potentially malicious tags or attributes (like `<script>`).
    4.  Store the resulting safe HTML in the `body_html` column.
-   **Display:** The application will render the content from the `body_html` column.

### 2. Comments

-   **Input Format:** Users will write comments using Markdown syntax.
-   **Database Schema:** No changes are needed. The `comments` table already has `body_md` and `body_html` columns that will be used for this process.
-   **Storage:** The raw Markdown from the comment input will be saved to the existing `body_md` column.
-   **Server-Side Rendering:** Similar to posts, on every save, the server will:
    1.  Take the raw comment Markdown from the `body_md` field.
    2.  Convert it to HTML.
    3.  Sanitize the resulting HTML.
    4.  Store the clean HTML in the existing `body_html` column.
-   **Display:** The application will render the content from the `body_html` column.

---

## Benefits

-   **Security:** This process is the primary defense against XSS attacks. By ensuring that all rendered content has been processed and sanitized in a trusted server environment, we prevent malicious scripts from being executed in users' browsers.
-   **Performance:** Rendering HTML from Markdown is a computationally intensive task. By performing this operation only once (on write) instead of on every read, we reduce server load and improve the response time for delivering content.
-   **Data Integrity:** Storing the original Markdown allows for easy editing and re-processing of content if the rendering or sanitization logic needs to be updated in the future.
