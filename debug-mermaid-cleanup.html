<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Cleanup Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-content {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log-output {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mermaid Cleanup Debug Tool</h1>
        <p>This tool helps debug the enhanced auto-conversion plugin's cleanup functionality.</p>
        
        <div class="test-section">
            <h2>Test Content (Complex Subgraph)</h2>
            <div class="test-content">```mermaid
flowchart TD
    %% Core Application Layer
    subgraph APP["🚀 Application Layer"]
        UI["👨‍💻 User Interface<br/>React Components"]
        API["🔌 API Routes<br/>Next.js Handlers"]
        AUTH["🔐 Authentication<br/>Auth.js"]
    end
    
    %% Business Logic Layer  
    subgraph BL["💼 Business Logic"]
        POSTS["📝 Post Management"]
        COMMENTS["💬 Comment System"] 
        ADMIN["⚙️ Admin Functions"]
        SEARCH["🔍 Search Engine"]
    end
    
    %% Data Layer
    subgraph DATA["🗄️ Data Layer"]
        PG["🐘 PostgreSQL<br/>Primary Database"]
        DRIZZLE["🌧️ Drizzle ORM<br/>Query Builder"]
        CACHE["⚡ Cache Layer"]
    end
    
    %% External Services
    subgraph EXT["🌐 External Services"]
        OAUTH["🔑 OAuth Providers<br/>GitHub, Google"]
        CDN["📡 Static Assets<br/>Images, CSS, JS"]
        EMAIL["📧 Email Service<br/>Notifications"]
    end
    
    %% Cross-layer connections
    UI --> API
    UI --> AUTH
    API --> POSTS
    API --> COMMENTS
    API --> ADMIN
    API --> SEARCH
    AUTH --> OAUTH
    POSTS --> DRIZZLE
    COMMENTS --> DRIZZLE
    ADMIN --> DRIZZLE
    SEARCH --> DRIZZLE
    DRIZZLE --> PG
    CACHE --> PG
    UI --> CDN
    ADMIN --> EMAIL
    
    %% Styling
    classDef appLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef businessLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataLayer fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef extLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    
    class APP,UI,API,AUTH appLayer
    class BL,POSTS,COMMENTS,ADMIN,SEARCH businessLayer  
    class DATA,PG,DRIZZLE,CACHE dataLayer
    class EXT,OAUTH,CDN,EMAIL extLayer
```</div>
            
            <button onclick="testMermaidCleanup()">Test Cleanup Function</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div class="results">
            <h3>Console Output</h3>
            <div id="log-output" class="log-output"></div>
        </div>
    </div>

    <script>
        let originalConsoleLog = console.log;
        let originalConsoleWarn = console.warn;
        let originalConsoleError = console.error;
        
        function logToOutput(level, ...args) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logOutput.textContent += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            
            // Also call original console method
            if (level === 'log') originalConsoleLog(...args);
            else if (level === 'warn') originalConsoleWarn(...args);
            else if (level === 'error') originalConsoleError(...args);
        }
        
        console.log = (...args) => logToOutput('log', ...args);
        console.warn = (...args) => logToOutput('warn', ...args);
        console.error = (...args) => logToOutput('error', ...args);
        
        function clearLogs() {
            document.getElementById('log-output').textContent = '';
        }
        
        function testMermaidCleanup() {
            console.log('🧪 Starting Mermaid cleanup test...');
            console.log('This would test the enhanced auto-conversion plugin');
            console.log('Visit http://localhost:3001/admin/posts/new to test the actual editor');
            console.log('Paste the mermaid content above and watch for cleanup logs in browser devtools');
            
            // Simulate what we expect to see
            console.log('Expected logs from enhanced auto-conversion plugin:');
            console.log('🔍 [MermaidAutoConvert] Final document analysis:');
            console.log('🔍 Node 1: { type: "mermaid", ... }');
            console.log('🚨 [MermaidAutoConvert] Found suspicious mermaid content in text node:');
            console.log('🧹 [MermaidAutoConvert] Attempting cleanup of residual mermaid content');
            console.log('🧹 Removing suspicious node at pos X');
            console.log('🧹 [MermaidAutoConvert] Cleanup applied, returning cleaned transaction');
        }
        
        // Log initial message
        console.log('🔍 Mermaid Cleanup Debug Tool loaded');
        console.log('Click "Test Cleanup Function" to see expected behavior');
        console.log('For real testing, visit: http://localhost:3001/admin/posts/new');
    </script>
</body>
</html>